<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Agregar Método de Pago</title>
    <script src="https://js.stripe.com/v3/"></script>
  </head>
  <body>
    <h3>Agregar Tarjeta</h3>
    <form id="payment-form">
      <div id="card-element"></div>
      <button type="submit">Guardar tarjeta</button>
    </form>

    <script>
      const stripe = Stripe(
        'pk_test_51RhvuvPGJtkI6cDmb6u7TwtXObALWsyuTvM34GBzuTtRH4JXhgGEjr1jzcSZaJ4R7996Xx2uYO0OyToqhrwJiwPJ00tpbox0IO'
      ); // Tu publishable key
      const elements = stripe.elements();
      const card = elements.create('card');
      card.mount('#card-element');

      const customerId = 'cus_SdEk1R0KyPgyjP'; // Simulado (traer del backend en real)
      const clientId = 1; // Simulado (id local de cliente en tu BD)

      document
        .getElementById('payment-form')
        .addEventListener('submit', async (e) => {
          e.preventDefault();

          // Paso 1: obtener client_secret
          const setupIntentRes = await fetch(
            '/api/v1/payments/create-setup-intent',
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ customerId }),
            }
          );

          const { clientSecret } = await setupIntentRes.json();

          // Paso 2: confirmar método
          const result = await stripe.confirmCardSetup(clientSecret, {
            payment_method: {
              card: card,
            },
          });

          if (result.error) {
            alert('❌ Error: ' + result.error.message);
          } else {
            // Paso 3: guardar en backend
            const saveRes = await fetch(
              '/api/v1/payments/save-payment-method',
              {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  clientId,
                  paymentMethodId: result.setupIntent.payment_method,
                }),
              }
            );

            const data = await saveRes.json();
            if (data.success) {
              alert('✅ Tarjeta guardada con éxito.');
            } else {
              alert('⚠️ No se pudo guardar el método.');
            }
          }
        });
    </script>
  </body>
</html>
